import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useOutletContext } from "react-router-dom";

type Ctx = { witnessMode?: boolean };

type Project = {
  id: string;
  name: string;
  description?: string;
  createdAt: number;
};

type Draft = {
  id: string;
  title: string;
  body: string;
  createdAt: number;
  updatedAt: number;
};

type Release = {
  id: string;
  projectId: string;
  title: string;
  statement: string;
  draftIds: string[];
  createdAt: number;
};

const PROJECTS_KEY = "hp.creator.projects.v1";
const ACTIVE_PROJECT_KEY = "hp.creator.activeProjectId.v1";
const ACTIVE_DRAFT_KEY = "hp.creator.activeArtifactId.v1";
const RELEASES_KEY = "hp.creator.build.releases.v1";

function safeJsonParse<T>(raw: string | null, fallback: T): T {
  try {
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function now() {
  return Date.now();
}

function makeId(prefix: string) {
  const t = now();
  const rnd =
    globalThis.crypto && "randomUUID" in globalThis.crypto
      ? globalThis.crypto.randomUUID()
      : Math.random().toString(16).slice(2);
  return `${prefix}_${t}_${rnd}`;
}

function fmt(ms: number) {
  return new Date(ms).toLocaleString();
}

export default function CreatorBuild() {
  const ctx = useOutletContext() as Ctx;
  const witness = !!ctx?.witnessMode;
  const nav = useNavigate();

  // -----------------------------
  // PROJECT
  // -----------------------------
  const [project, setProject] = useState<Project | null>(null);

  function ensureProject(): Project {
    const projects = safeJsonParse<Project[]>(
      localStorage.getItem(PROJECTS_KEY),
      []
    );

    const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
    const existing = projects.find(p => p.id === activeId);
    if (existing) {
      setProject(existing);
      return existing;
    }

    const p: Project = {
      id: makeId("p"),
      name: "Untitled Project",
      createdAt: now(),
    };

    const next = [p, ...projects];
    localStorage.setItem(PROJECTS_KEY, JSON.stringify(next));
    localStorage.setItem(ACTIVE_PROJECT_KEY, p.id);
    setProject(p);
    return p;
  }

  const draftsKey = useMemo(() => {
    if (!project?.id) return null;
    return `hp.creator.build.artifacts.v1.${project.id}`;
  }, [project?.id]);

  // -----------------------------
  // DRAFTS
  // -----------------------------
  const [drafts, setDrafts] = useState<Draft[]>([]);
  const [activeDraftId, setActiveDraftId] = useState<string | null>(null);
  const autoDraftIdRef = useRef<string | null>(null);

  const activeDraft = useMemo(
    () => drafts.find(d => d.id === activeDraftId) ?? null,
    [drafts, activeDraftId]
  );

  // -----------------------------
  // IDEA SURFACE
  // -----------------------------
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [status, setStatus] = useState<string>("Saved");

  function ensureAutoDraft(nextTitle: string, nextBody: string) {
    const t = nextTitle.trim();
    const b = nextBody.trim();
    if (!t && !b) return;

    const p = project ?? ensureProject();
    if (!p) return;

    const existingId = autoDraftIdRef.current;
    const exists = existingId && drafts.some(d => d.id === existingId);

    if (!exists) {
      const id = makeId("d");
      const ts = now();
      const d: Draft = {
        id,
        title: t || "Untitled Draft",
        body: nextBody,
        createdAt: ts,
        updatedAt: ts,
      };
      autoDraftIdRef.current = id;
      setDrafts(prev => [d, ...prev]);
      setActiveDraftId(id);
      setStatus("Saved");
      return;
    }

    setDrafts(prev =>
      prev.map(d =>
        d.id === existingId
          ? { ...d, title: t || "Untitled Draft", body: nextBody, updatedAt: now() }
          : d
      )
    );
    setStatus("Saved");
  }

  // -----------------------------
  // INITIAL LOAD
  // -----------------------------
  useEffect(() => {
    const projects = safeJsonParse<Project[]>(
      localStorage.getItem(PROJECTS_KEY),
      []
    );
    const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);
    const p = projects.find(x => x.id === activeId) ?? null;
    setProject(p);

    if (p) {
      const key = `hp.creator.build.artifacts.v1.${p.id}`;
      const items = safeJsonParse<Draft[]>(localStorage.getItem(key), []);
      items.sort((a, b) => b.createdAt - a.createdAt);
      setDrafts(items);

      const ad = localStorage.getItem(ACTIVE_DRAFT_KEY);
      setActiveDraftId(
        ad && items.some(x => x.id === ad) ? ad : items[0]?.id ?? null
      );
    }
  }, []);

  useEffect(() => {
    if (!draftsKey) return;
    localStorage.setItem(draftsKey, JSON.stringify(drafts));
  }, [draftsKey, drafts]);

  useEffect(() => {
    if (activeDraftId)
      localStorage.setItem(ACTIVE_DRAFT_KEY, activeDraftId);
  }, [activeDraftId]);

  // -----------------------------
  // UI
  // -----------------------------
  return (
    <div style={{ maxWidth: 1100, margin: "0 auto", padding: "24px 20px 60px" }}>
      <div style={{ fontSize: 22, fontWeight: 800, marginBottom: 10 }}>
        Start with an idea.
      </div>

      <input
        value={title}
        onChange={e => {
          setTitle(e.target.value);
          ensureAutoDraft(e.target.value, body);
        }}
        placeholder="What are you building?"
        style={{
          width: "100%",
          padding: "12px 14px",
          fontSize: 16,
          fontWeight: 800,
          borderRadius: 12,
          border: "1px solid rgba(255,255,255,0.14)",
          background: "rgba(0,0,0,0.25)",
          color: "white",
          marginBottom: 10,
        }}
      />

      <textarea
        value={body}
        onChange={e => {
          setBody(e.target.value);
          ensureAutoDraft(title, e.target.value);
        }}
        placeholder="Start typing. HomePlanet takes care of the rest."
        rows={7}
        style={{
          width: "100%",
          padding: 14,
          borderRadius: 12,
          border: "1px solid rgba(255,255,255,0.14)",
          background: "rgba(0,0,0,0.28)",
          color: "white",
        }}
      />

      <div style={{ marginTop: 8, fontSize: 13, color: "rgba(255,255,255,0.6)" }}>
        ● {status}
      </div>
    </div>
  );
}

