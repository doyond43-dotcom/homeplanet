import React, { useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";

type Project = {
  id: string;
  name: string;
  description?: string;
  createdAt: number;
};

const STORAGE_KEY = "hp.creator.projects.v1";

function loadProjects(): Project[] {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed
      .filter((p) => p && typeof p.id === "string" && typeof p.name === "string" && typeof p.createdAt === "number")
      .sort((a, b) => b.createdAt - a.createdAt);
  } catch {
    return [];
  }
}

export default function CreatorBuild() {
  const nav = useNavigate();
  const [q, setQ] = useState("");
  const projects = useMemo(() => loadProjects(), []);
  const matches = useMemo(() => {
    const s = q.trim().toLowerCase();
    if (!s) return projects.slice(0, 5);
    return projects
      .filter((p) => (p.name + " " + (p.description ?? "")).toLowerCase().includes(s))
      .slice(0, 5);
  }, [q, projects]);

  return (
    <div>
      <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 12, flexWrap: "wrap" }}>
        <div>
          <h1 style={{ fontSize: 24, margin: 0 }}>🏗 Creator / Build</h1>
          <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5, maxWidth: 900 }}>
            Pick a project → then the Build actions appear. No dropdowns yet. Just momentum.
          </p>
        </div>

        <button
          onClick={() => nav("/planet/creator/projects")}
          style={{
            padding: "10px 12px",
            borderRadius: 14,
            border: "1px solid rgba(255,255,255,0.12)",
            background: "rgba(255,255,255,0.04)",
            color: "rgba(255,255,255,0.80)",
            cursor: "pointer",
            fontWeight: 900,
            height: 38,
          }}
        >
          Go to Projects →
        </button>
      </div>

      <div style={{
        marginTop: 14,
        borderRadius: 18,
        border: "1px solid rgba(255,255,255,0.10)",
        background: "rgba(255,255,255,0.03)",
        padding: 14,
      }}>
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Select Project</div>

        <input
          value={q}
          onChange={(e) => setQ(e.target.value)}
          placeholder="Type to find a project…"
          style={{
            width: "100%",
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid rgba(255,255,255,0.12)",
            background: "rgba(0,0,0,0.25)",
            color: "rgba(255,255,255,0.92)",
            outline: "none",
          }}
        />

        <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          {projects.length === 0 ? (
            <div style={{
              borderRadius: 16,
              border: "1px dashed rgba(255,255,255,0.14)",
              background: "rgba(255,255,255,0.02)",
              padding: 14,
              color: "rgba(255,255,255,0.65)"
            }}>
              No projects found yet. Create one in <b>Creator / Projects</b> first.
            </div>
          ) : (
            matches.map((p) => (
              <button
                key={p.id}
                onClick={() => {
                  // for v1 we just navigate to Projects (later we’ll pass selected project context)
                  nav("/planet/creator/projects");
                }}
                style={{
                  textAlign: "left",
                  borderRadius: 16,
                  border: "1px solid rgba(255,255,255,0.10)",
                  background: "rgba(255,255,255,0.03)",
                  padding: 14,
                  cursor: "pointer",
                  color: "rgba(255,255,255,0.92)",
                }}
                title="For v1, selection routes back to Projects (next patch will keep selection + unlock build actions)"
              >
                <div style={{ fontWeight: 900 }}>{p.name}</div>
                {p.description ? (
                  <div style={{ marginTop: 6, color: "rgba(255,255,255,0.70)", lineHeight: 1.45 }}>
                    {p.description.length > 120 ? p.description.slice(0, 120) + "…" : p.description}
                  </div>
                ) : (
                  <div style={{ marginTop: 6, color: "rgba(255,255,255,0.55)" }}>No description.</div>
                )}
              </button>
            ))
          )}
        </div>
      </div>

      <div style={{
        marginTop: 16,
        borderRadius: 18,
        border: "1px solid rgba(255,255,255,0.10)",
        background: "rgba(255,255,255,0.03)",
        padding: 14,
      }}>
        <div style={{ fontWeight: 900 }}>Build Actions (next)</div>
        <div style={{ marginTop: 8, color: "rgba(255,255,255,0.65)", lineHeight: 1.5 }}>
          Next patch will unlock action cards after a project is selected:
          <br />• Start Build • Attach Artifact • Create Demo • Commerce Package • Timestamp / Witness
        </div>
      </div>
    </div>
  );
}
