import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useOutletContext } from "react-router-dom";

type Ctx = { witnessMode?: boolean };

type Project = {
  id: string;
  name: string;
  description?: string;
  createdAt: number;
};

type Artifact = {
  id: string;
  title: string;
  body: string;
  createdAt: number; // presence-first creation moment for this artifact
  updatedAt: number;
};

type Release = {
  id: string;
  projectId: string;
  title: string;
  statement: string;
  artifactIds: string[];
  createdAt: number;
};

const PROJECTS_KEY = "hp.creator.projects.v1";
const ACTIVE_PROJECT_KEY = "hp.creator.activeProjectId.v1";
const ACTIVE_ARTIFACT_KEY = "hp.creator.activeArtifactId.v1";
const RELEASES_KEY = "hp.creator.build.releases.v1";

function safeJsonParse<T>(raw: string | null, fallback: T): T {
  try {
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function safeGetItem(key: string): string | null {
  try {
    return localStorage.getItem(key);
  } catch {
    return null;
  }
}

function safeSetItem(key: string, value: string) {
  try {
    localStorage.setItem(key, value);
  } catch {
    // ignore
  }
}

function now() {
  return Date.now();
}

function makeId(prefix: string) {
  const t = now();
  const rnd =
    globalThis.crypto && "randomUUID" in globalThis.crypto
      ? globalThis.crypto.randomUUID()
      : Math.random().toString(16).slice(2);
  return `${prefix}_${t}_${rnd}`;
}

function fmt(ms: number) {
  return new Date(ms).toLocaleString();
}

export default function CreatorBuild() {
  const ctx = useOutletContext() as Ctx;
  const witness = !!ctx?.witnessMode;
  const nav = useNavigate();

  const [project, setProject] = useState<Project | null>(null);
  const [artifacts, setArtifacts] = useState<Artifact[]>([]);
  const [activeArtifactId, setActiveArtifactId] = useState<string | null>(null);

  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [status, setStatus] = useState<string | null>(null);

  // Release composer
  const [releaseTitle, setReleaseTitle] = useState("Public Release v1");
  const [releaseStatement, setReleaseStatement] = useState(
    "HomePlanet lets you build privately, then release publicly with proof that can’t be argued later."
  );
  const [releases, setReleases] = useState<Release[]>([]);

  const composerRef = useRef<HTMLInputElement | null>(null);

  const artifactsKey = useMemo(() => {
    if (!project?.id) return null;
    return `hp.creator.build.artifacts.v1.${project.id}`;
  }, [project?.id]);

  // ✅ Fix #1: Build is authoritative about active project
  // - reads ACTIVE_PROJECT_KEY
  // - if missing/invalid, redirects to Projects (no dead-end / no white screen)
  useEffect(() => {
    const projects = safeJsonParse<Project[]>(safeGetItem(PROJECTS_KEY), []);
    const activeId = safeGetItem(ACTIVE_PROJECT_KEY);

    // Hard guard: no active key -> go pick project
    if (!activeId) {
      nav("/planet/creator/projects", { replace: true });
      return;
    }

    const p = projects.find((x) => x.id === activeId) ?? null;

    // Hard guard: key exists but project not found -> key is stale -> go pick project
    if (!p) {
      nav("/planet/creator/projects", { replace: true });
      return;
    }

    setProject(p);

    const allReleases = safeJsonParse<Release[]>(safeGetItem(RELEASES_KEY), []);
    setReleases(allReleases.sort((a, b) => b.createdAt - a.createdAt));

    const key = `hp.creator.build.artifacts.v1.${p.id}`;
    const items = safeJsonParse<Artifact[]>(safeGetItem(key), []);
    items.sort((a, b) => b.createdAt - a.createdAt);
    setArtifacts(items);

    const aa = safeGetItem(ACTIVE_ARTIFACT_KEY);
    setActiveArtifactId(aa && items.some((x) => x.id === aa) ? aa : items[0]?.id ?? null);
  }, [nav]);

  // Persist artifacts
  useEffect(() => {
    if (!artifactsKey) return;
    safeSetItem(artifactsKey, JSON.stringify(artifacts));
  }, [artifactsKey, artifacts]);

  // Persist active artifact
  useEffect(() => {
    if (!activeArtifactId) return;
    safeSetItem(ACTIVE_ARTIFACT_KEY, activeArtifactId);
  }, [activeArtifactId]);

  // Persist releases
  useEffect(() => {
    safeSetItem(RELEASES_KEY, JSON.stringify(releases));
  }, [releases]);

  const activeArtifact = useMemo(
    () => artifacts.find((a) => a.id === activeArtifactId) ?? null,
    [artifacts, activeArtifactId]
  );

  const canCreate = title.trim().length >= 2;
  const canRelease = !!project && artifacts.length > 0 && releaseTitle.trim().length >= 2;

  function goSwitchProject() {
    nav("/planet/creator/projects");
  }

  function startBuilding() {
    setStatus("Pick a title and create your first artifact.");
    window.setTimeout(() => composerRef.current?.focus(), 60);
  }

  function createArtifact() {
    setStatus(null);

    const t = title.trim();
    if (t.length < 2) {
      setStatus("Title must be at least 2 characters.");
      composerRef.current?.focus();
      return;
    }

    const id = makeId("a");
    const ts = now();

    const a: Artifact = {
      id,
      title: t,
      body: body ?? "",
      createdAt: ts,
      updatedAt: ts,
    };

    setArtifacts((prev) => [a, ...prev]);
    setActiveArtifactId(id);

    setTitle("");
    setBody("");

    setStatus("Created. It’s saved locally. Refresh to prove it persists.");
  }

  function openArtifact(id: string) {
    setActiveArtifactId(id);
    setStatus(null);
  }

  function updateActiveBody(next: string) {
    if (!activeArtifactId) return;
    setArtifacts((prev) =>
      prev.map((a) => (a.id === activeArtifactId ? { ...a, body: next, updatedAt: now() } : a))
    );
  }

  function removeArtifact(id: string) {
    setArtifacts((prev) => prev.filter((a) => a.id !== id));
    if (activeArtifactId === id) {
      const next = artifacts.find((a) => a.id !== id)?.id ?? null;
      setActiveArtifactId(next);
    }
  }

  function createReleaseAndView() {
    setStatus(null);
    if (!project) return;

    if (!canRelease) {
      setStatus("To release, you need at least 1 artifact and a release title.");
      return;
    }

    const r: Release = {
      id: makeId("r"),
      projectId: project.id,
      title: releaseTitle.trim(),
      statement: releaseStatement.trim() || "Released publicly with anchored proof.",
      artifactIds: artifacts.map((a) => a.id),
      createdAt: now(),
    };

    setReleases((prev) => [r, ...prev]);
    setStatus("Released. Opening the public viewer…");

    // Jump straight into public viewer
    nav(`/planet/creator/release/${r.id}`);
  }

  function viewRelease(rid: string) {
    nav(`/planet/creator/release/${rid}`);
  }

  // With the hard redirect above, this should rarely render,
  // but keep it as a safe fallback if navigation is blocked.
  if (!project) {
    return (
      <div>
        <h1 style={{ fontSize: 24, margin: 0 }}>🧱 Creator / Build</h1>
        <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5 }}>
          Build starts from an anchored project — but none is selected.
        </p>
        <button
          onClick={goSwitchProject}
          style={{
            marginTop: 12,
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid rgba(255,255,255,0.14)",
            background: "rgba(255,255,255,0.08)",
            color: "rgba(255,255,255,0.92)",
            cursor: "pointer",
            fontWeight: 900,
          }}
        >
          Go select a project →
        </button>
      </div>
    );
  }

  return (
    <div>
      <h1 style={{ fontSize: 24, margin: 0 }}>🧱 Creator / Build</h1>
      <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5 }}>
        Build is where the “holy shit” happens. It always starts from an anchored project.
      </p>

      <div
        style={{
          marginTop: 14,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 8 }}>Active Project</div>

        <div style={{ fontWeight: 900, fontSize: 16 }}>{project.name}</div>
        {project.description && (
          <div style={{ marginTop: 8, color: "rgba(255,255,255,0.70)", lineHeight: 1.45 }}>
            {project.description}
          </div>
        )}

        <div style={{ marginTop: 10, color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
          Presence Anchor: {fmt(project.createdAt)}{" "}
          {witness ? <span style={{ marginLeft: 10, opacity: 0.9 }}>• Witness ON</span> : null}
        </div>

        <div style={{ marginTop: 12, display: "flex", gap: 10, flexWrap: "wrap" }}>
          <button
            onClick={startBuilding}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.16)",
              background: "rgba(255,255,255,0.10)",
              color: "rgba(255,255,255,0.92)",
              cursor: "pointer",
              fontWeight: 900,
            }}
          >
            Start Building →
          </button>

          <button
            onClick={goSwitchProject}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.20)",
              color: "rgba(255,255,255,0.78)",
              cursor: "pointer",
              fontWeight: 900,
            }}
          >
            Switch Project
          </button>

          <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12, alignSelf: "center" }}>
            Active ID stored at: {ACTIVE_PROJECT_KEY}
          </div>
        </div>
      </div>

      {/* BUILD */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
          <div style={{ fontWeight: 900 }}>Build Artifacts</div>
          <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>Count: {artifacts.length}</div>
        </div>

        <div style={{ marginTop: 10, display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          <input
            ref={composerRef}
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="Artifact title (example: Landing Page Draft)"
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
            }}
          />

          <textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder="Start writing… (this becomes your next presence-anchored artifact)"
            rows={4}
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
            <button
              onClick={createArtifact}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.16)",
                background: canCreate ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.05)",
                color: canCreate ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 900,
              }}
              title={canCreate ? "Create artifact" : "Enter a title first"}
            >
              Create Artifact (saved) →
            </button>

            {status && <div style={{ color: "rgba(255,255,255,0.70)", fontSize: 12 }}>{status}</div>}

            <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12 }}>
              Stored at: <span style={{ opacity: 0.9 }}>{artifactsKey ?? "…"}</span>
            </div>
          </div>
        </div>

        <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "minmax(260px, 360px) 1fr", gap: 12 }}>
          {/* List */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 10,
              minHeight: 160,
            }}
          >
            {artifacts.length === 0 ? (
              <div style={{ color: "rgba(255,255,255,0.65)", padding: 10 }}>
                No artifacts yet. Click <b>Start Building →</b>, then create your first artifact above.
              </div>
            ) : (
              artifacts.map((a) => {
                const active = a.id === activeArtifactId;
                return (
                  <button
                    key={a.id}
                    onClick={() => openArtifact(a.id)}
                    style={{
                      width: "100%",
                      textAlign: "left",
                      padding: "10px 10px",
                      borderRadius: 12,
                      border: active ? "1px solid rgba(255,255,255,0.22)" : "1px solid rgba(255,255,255,0.10)",
                      background: active ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.03)",
                      color: "rgba(255,255,255,0.90)",
                      cursor: "pointer",
                      fontWeight: 900,
                      marginBottom: 8,
                    }}
                    title="Open artifact"
                  >
                    <div style={{ fontSize: 13 }}>{a.title}</div>
                    <div style={{ marginTop: 4, fontSize: 11, color: "rgba(255,255,255,0.55)", fontWeight: 700 }}>
                      Created: {fmt(a.createdAt)}
                    </div>
                  </button>
                );
              })
            )}
          </div>

          {/* Editor */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 12,
              minHeight: 160,
            }}
          >
            {!activeArtifact ? (
              <div style={{ color: "rgba(255,255,255,0.65)" }}>Select an artifact to open it here.</div>
            ) : (
              <>
                <div style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "baseline" }}>
                  <div style={{ fontWeight: 900 }}>{activeArtifact.title}</div>
                  <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
                    Updated: {fmt(activeArtifact.updatedAt)}
                  </div>
                </div>

                <textarea
                  value={activeArtifact.body}
                  onChange={(e) => updateActiveBody(e.target.value)}
                  placeholder="Write here…"
                  rows={10}
                  style={{
                    marginTop: 10,
                    width: "100%",
                    padding: "10px 12px",
                    borderRadius: 12,
                    border: "1px solid rgba(255,255,255,0.12)",
                    background: "rgba(0,0,0,0.22)",
                    color: "rgba(255,255,255,0.92)",
                    outline: "none",
                    resize: "vertical",
                  }}
                />

                <div style={{ marginTop: 10, display: "flex", justifyContent: "flex-end" }}>
                  <button
                    onClick={() => removeArtifact(activeArtifact.id)}
                    style={{
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.12)",
                      background: "rgba(0,0,0,0.20)",
                      color: "rgba(255,255,255,0.75)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    Remove Artifact
                  </button>
                </div>

                <div style={{ marginTop: 8, color: "rgba(255,255,255,0.45)", fontSize: 11 }}>
                  Presence Anchor: {fmt(activeArtifact.createdAt)} • ID: {activeArtifact.id}
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      {/* RELEASE */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Release (Public Truth)</div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          <input
            value={releaseTitle}
            onChange={(e) => setReleaseTitle(e.target.value)}
            placeholder="Release title (example: Creator Demo Release v1)"
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
            }}
          />

          <textarea
            value={releaseStatement}
            onChange={(e) => setReleaseStatement(e.target.value)}
            placeholder="Release statement (the one-sentence lock-in)"
            rows={3}
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
            <button
              onClick={createReleaseAndView}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.18)",
                background: canRelease ? "rgba(255,255,255,0.14)" : "rgba(255,255,255,0.05)",
                color: canRelease ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 1000,
              }}
              title={canRelease ? "Freeze artifacts + open Release Viewer" : "Create at least 1 artifact first"}
            >
              Release → View Public Record
            </button>

            <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12 }}>
              Releases stored at: <span style={{ opacity: 0.9 }}>{RELEASES_KEY}</span>
            </div>
          </div>
        </div>

        {releases.length > 0 && (
          <div style={{ marginTop: 12 }}>
            <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 12, marginBottom: 8 }}>Recent Releases</div>

            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 10 }}>
              {releases.slice(0, 6).map((r) => (
                <div
                  key={r.id}
                  style={{
                    borderRadius: 14,
                    border: "1px solid rgba(255,255,255,0.10)",
                    background: "rgba(0,0,0,0.18)",
                    padding: 12,
                  }}
                >
                  <div style={{ fontWeight: 900 }}>{r.title}</div>
                  <div style={{ marginTop: 6, color: "rgba(255,255,255,0.65)", fontSize: 12, lineHeight: 1.35 }}>
                    Released: {fmt(r.createdAt)} • Artifacts: {r.artifactIds.length}
                  </div>

                  <button
                    onClick={() => viewRelease(r.id)}
                    style={{
                      marginTop: 10,
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.14)",
                      background: "rgba(255,255,255,0.08)",
                      color: "rgba(255,255,255,0.92)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    View Release →
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}


