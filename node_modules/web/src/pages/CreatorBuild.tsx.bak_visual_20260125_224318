import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useOutletContext } from "react-router-dom";

type Ctx = { witnessMode?: boolean };

type Project = {
  id: string;
  name: string;
  description?: string;
  createdAt: number;
};

type Draft = {
  id: string;
  title: string;
  body: string;
  createdAt: number;
  updatedAt: number;
};

type Release = {
  id: string;
  projectId: string;
  title: string;
  statement: string;
  artifactIds: string[];
  createdAt: number;
};

const PROJECTS_KEY = "hp.creator.projects.v1";
const ACTIVE_PROJECT_KEY = "hp.creator.activeProjectId.v1";
const ACTIVE_DRAFT_KEY = "hp.creator.activeArtifactId.v1"; // (keep storage key stable)
const RELEASES_KEY = "hp.creator.build.releases.v1";

function safeJsonParse<T>(raw: string | null, fallback: T): T {
  try {
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function safeGetItem(key: string): string | null {
  try {
    return localStorage.getItem(key);
  } catch {
    return null;
  }
}

function safeSetItem(key: string, value: string) {
  try {
    localStorage.setItem(key, value);
  } catch {
    // ignore
  }
}

function now() {
  return Date.now();
}

function makeId(prefix: string) {
  const t = now();
  const rnd =
    globalThis.crypto && "randomUUID" in globalThis.crypto
      ? globalThis.crypto.randomUUID()
      : Math.random().toString(16).slice(2);
  return `${prefix}_${t}_${rnd}`;
}

function fmt(ms: number) {
  return new Date(ms).toLocaleString();
}

export default function CreatorBuild() {
  const ctx = useOutletContext() as Ctx;
  const witness = !!ctx?.witnessMode;
  const nav = useNavigate();

  const [project, setProject] = useState<Project | null>(null);
  const [drafts, setDrafts] = useState<Draft[]>([]);
  const [activeDraftId, setActiveDraftId] = useState<string | null>(null);

  // Composer (first-30-seconds surface)
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [status, setStatus] = useState<string | null>(null);

  // Release composer (keep as-is for now; later we’ll defer/quiet it)
  const [releaseTitle, setReleaseTitle] = useState("Public Release v1");
  const [releaseStatement, setReleaseStatement] = useState(
    "HomePlanet lets you build privately, then release publicly with proof that can’t be argued later."
  );
  const [releases, setReleases] = useState<Release[]>([]);

  const titleRef = useRef<HTMLInputElement | null>(null);
  const implicitCreatedRef = useRef(false);

  const draftsKey = useMemo(() => {
    if (!project?.id) return null;
    // keep storage namespace stable (internals can still say “artifacts”)
    return `hp.creator.build.artifacts.v1.${project.id}`;
  }, [project?.id]);

  // Fix #1: Build is authoritative about the active project
  useEffect(() => {
    const projects = safeJsonParse<Project[]>(safeGetItem(PROJECTS_KEY), []);
    const activeId = safeGetItem(ACTIVE_PROJECT_KEY);

    if (!activeId) {
      nav("/planet/creator/projects", { replace: true });
      return;
    }

    const p = projects.find((x) => x.id === activeId) ?? null;
    if (!p) {
      nav("/planet/creator/projects", { replace: true });
      return;
    }

    setProject(p);

    const allReleases = safeJsonParse<Release[]>(safeGetItem(RELEASES_KEY), []);
    setReleases(allReleases.sort((a, b) => b.createdAt - a.createdAt));

    const key = `hp.creator.build.artifacts.v1.${p.id}`;
    const items = safeJsonParse<Draft[]>(safeGetItem(key), []);
    items.sort((a, b) => b.createdAt - a.createdAt);
    setDrafts(items);

    const ad = safeGetItem(ACTIVE_DRAFT_KEY);
    setActiveDraftId(ad && items.some((x) => x.id === ad) ? ad : items[0]?.id ?? null);

    // First-30-seconds: cursor blinking immediately
    window.setTimeout(() => titleRef.current?.focus(), 80);
  }, [nav]);

  // Persist drafts
  useEffect(() => {
    if (!draftsKey) return;
    safeSetItem(draftsKey, JSON.stringify(drafts));
  }, [draftsKey, drafts]);

  // Persist active draft
  useEffect(() => {
    if (!activeDraftId) return;
    safeSetItem(ACTIVE_DRAFT_KEY, activeDraftId);
  }, [activeDraftId]);

  // Persist releases
  useEffect(() => {
    safeSetItem(RELEASES_KEY, JSON.stringify(releases));
  }, [releases]);

  const activeDraft = useMemo(
    () => drafts.find((d) => d.id === activeDraftId) ?? null,
    [drafts, activeDraftId]
  );

  const canSaveExplicit = title.trim().length >= 2;
  const canRelease = !!project && drafts.length > 0 && releaseTitle.trim().length >= 2;

  function goSwitchProject() {
    nav("/planet/creator/projects");
  }

  // Step 4: Implicit first draft (first keystroke creates Draft #1)
  function createImplicitDraftIfNeeded(nextTitle?: string, nextBody?: string) {
    if (implicitCreatedRef.current) return;
    if (drafts.length > 0) {
      implicitCreatedRef.current = true;
      return;
    }

    const hasContent =
      (nextTitle && nextTitle.trim().length > 0) ||
      (nextBody && nextBody.trim().length > 0);

    if (!hasContent) return;

    implicitCreatedRef.current = true;

    const id = makeId("a");
    const ts = now();

    const d: Draft = {
      id,
      title: (nextTitle?.trim() || "Untitled").slice(0, 140),
      body: nextBody ?? "",
      createdAt: ts,
      updatedAt: ts,
    };

    setDrafts((prev) => [d, ...prev]);
    setActiveDraftId(id);
    setStatus(null);
  }

  // Explicit save still allowed (creates a new draft)
  function saveDraftExplicit() {
    setStatus(null);

    const t = title.trim();
    if (t.length < 2) {
      setStatus("Title must be at least 2 characters.");
      titleRef.current?.focus();
      return;
    }

    const id = makeId("a");
    const ts = now();

    const d: Draft = {
      id,
      title: t,
      body: body ?? "",
      createdAt: ts,
      updatedAt: ts,
    };

    setDrafts((prev) => [d, ...prev]);
    setActiveDraftId(id);

    setTitle("");
    setBody("");

    setStatus("Saved. Refresh to prove it persists.");
  }

  function openDraft(id: string) {
    setActiveDraftId(id);
    setStatus(null);
  }

  function updateActiveBody(next: string) {
    if (!activeDraftId) return;
    setDrafts((prev) =>
      prev.map((d) =>
        d.id === activeDraftId ? { ...d, body: next, updatedAt: now() } : d
      )
    );
  }

  function deleteDraft(id: string) {
    setDrafts((prev) => prev.filter((d) => d.id !== id));
    if (activeDraftId === id) {
      const next = drafts.find((d) => d.id !== id)?.id ?? null;
      setActiveDraftId(next);
    }
  }

  function createReleaseAndView() {
    setStatus(null);
    if (!project) return;

    if (!canRelease) {
      setStatus("To release, you need at least 1 draft and a release title.");
      return;
    }

    const r: Release = {
      id: makeId("r"),
      projectId: project.id,
      title: releaseTitle.trim(),
      statement: releaseStatement.trim() || "Released publicly with anchored proof.",
      artifactIds: drafts.map((d) => d.id),
      createdAt: now(),
    };

    setReleases((prev) => [r, ...prev]);
    setStatus("Released. Opening the public viewer…");
    nav(`/planet/creator/release/${r.id}`);
  }

  function viewRelease(rid: string) {
    nav(`/planet/creator/release/${rid}`);
  }

  if (!project) {
    return (
      <div>
        <h1 style={{ fontSize: 24, margin: 0 }}>🧱 Creator / Write</h1>
        <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5 }}>
          Start with an idea — but no project is selected.
        </p>
        <button
          onClick={goSwitchProject}
          style={{
            marginTop: 12,
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid rgba(255,255,255,0.14)",
            background: "rgba(255,255,255,0.08)",
            color: "rgba(255,255,255,0.92)",
            cursor: "pointer",
            fontWeight: 900,
          }}
        >
          Go select an idea →
        </button>
      </div>
    );
  }

  return (
    <div>
      <h1 style={{ fontSize: 24, margin: 0 }}>🧱 Creator / Write</h1>
      <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5 }}>
        Start with an idea.
      </p>

      {/* Quiet context card (still here, just not the “front door”) */}
      <div
        style={{
          marginTop: 10,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.02)",
          padding: 12,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 6 }}>You’re working on</div>
        <div style={{ fontWeight: 900, fontSize: 16 }}>{project.name}</div>
        {project.description && (
          <div style={{ marginTop: 8, color: "rgba(255,255,255,0.70)", lineHeight: 1.45 }}>
            {project.description}
          </div>
        )}
        <div style={{ marginTop: 10, color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
          Saved: {fmt(project.createdAt)}
          {witness ? <span style={{ marginLeft: 10, opacity: 0.9 }}>• Witness ON</span> : null}
        </div>
        <div style={{ marginTop: 10, display: "flex", gap: 10, flexWrap: "wrap" }}>
          <button
            onClick={goSwitchProject}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.20)",
              color: "rgba(255,255,255,0.78)",
              cursor: "pointer",
              fontWeight: 900,
            }}
          >
            Switch Idea
          </button>
          <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12, alignSelf: "center" }}>
            Proof key: {ACTIVE_PROJECT_KEY}
          </div>
        </div>
      </div>

      {/* First-30-seconds writing surface */}
      <div
        style={{
          marginTop: 14,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Write</div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          <input
            ref={titleRef}
            value={title}
            onChange={(e) => {
              const v = e.target.value;
              setTitle(v);
              createImplicitDraftIfNeeded(v, body);
            }}
            placeholder="Draft title (example: Landing Page)"
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
            }}
          />

          <textarea
            value={body}
            onChange={(e) => {
              const v = e.target.value;
              setBody(v);
              createImplicitDraftIfNeeded(title, v);
            }}
            placeholder="Start writing… (everything saves automatically)"
            rows={5}
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
            <button
              onClick={saveDraftExplicit}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.16)",
                background: canSaveExplicit ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.05)",
                color: canSaveExplicit ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 900,
              }}
              title={canSaveExplicit ? "Save draft" : "Enter a title first"}
            >
              Save Draft →
            </button>

            {status && <div style={{ color: "rgba(255,255,255,0.70)", fontSize: 12 }}>{status}</div>}

            <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12 }}>
              Stored at: <span style={{ opacity: 0.9 }}>{draftsKey ?? "…"}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Drafts + editor (existing system, now labeled for humans) */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
          <div style={{ fontWeight: 900 }}>Drafts</div>
          <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>Count: {drafts.length}</div>
        </div>

        <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "minmax(260px, 360px) 1fr", gap: 12 }}>
          {/* List */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 10,
              minHeight: 160,
            }}
          >
            {drafts.length === 0 ? (
              <div style={{ color: "rgba(255,255,255,0.65)", padding: 10 }}>
                No drafts yet. Start typing above.
              </div>
            ) : (
              drafts.map((d) => {
                const active = d.id === activeDraftId;
                return (
                  <button
                    key={d.id}
                    onClick={() => openDraft(d.id)}
                    style={{
                      width: "100%",
                      textAlign: "left",
                      padding: "10px 10px",
                      borderRadius: 12,
                      border: active ? "1px solid rgba(255,255,255,0.22)" : "1px solid rgba(255,255,255,0.10)",
                      background: active ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.03)",
                      color: "rgba(255,255,255,0.90)",
                      cursor: "pointer",
                      fontWeight: 900,
                      marginBottom: 8,
                    }}
                    title="Open draft"
                  >
                    <div style={{ fontSize: 13 }}>{d.title}</div>
                    <div style={{ marginTop: 4, fontSize: 11, color: "rgba(255,255,255,0.55)", fontWeight: 700 }}>
                      Saved: {fmt(d.createdAt)}
                    </div>
                  </button>
                );
              })
            )}
          </div>

          {/* Editor */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 12,
              minHeight: 160,
            }}
          >
            {!activeDraft ? (
              <div style={{ color: "rgba(255,255,255,0.65)" }}>
                Select a draft to open it here.
              </div>
            ) : (
              <>
                <div style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "baseline" }}>
                  <div style={{ fontWeight: 900 }}>{activeDraft.title}</div>
                  <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
                    Updated: {fmt(activeDraft.updatedAt)}
                  </div>
                </div>

                <textarea
                  value={activeDraft.body}
                  onChange={(e) => updateActiveBody(e.target.value)}
                  placeholder="Write here…"
                  rows={10}
                  style={{
                    marginTop: 10,
                    width: "100%",
                    padding: "10px 12px",
                    borderRadius: 12,
                    border: "1px solid rgba(255,255,255,0.12)",
                    background: "rgba(0,0,0,0.22)",
                    color: "rgba(255,255,255,0.92)",
                    outline: "none",
                    resize: "vertical",
                  }}
                />

                <div style={{ marginTop: 10, display: "flex", justifyContent: "flex-end" }}>
                  <button
                    onClick={() => deleteDraft(activeDraft.id)}
                    style={{
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.12)",
                      background: "rgba(0,0,0,0.20)",
                      color: "rgba(255,255,255,0.75)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    Delete Draft
                  </button>
                </div>

                <div style={{ marginTop: 8, color: "rgba(255,255,255,0.45)", fontSize: 11 }}>
                  Saved: {fmt(activeDraft.createdAt)} • ID: {activeDraft.id}
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      {/* RELEASE (still present; later we’ll defer/quiet this for first-30-seconds) */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Release (Public Truth)</div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          <input
            value={releaseTitle}
            onChange={(e) => setReleaseTitle(e.target.value)}
            placeholder="Release title (example: Creator Demo Release v1)"
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
            }}
          />

          <textarea
            value={releaseStatement}
            onChange={(e) => setReleaseStatement(e.target.value)}
            placeholder="Release statement (the one-sentence lock-in)"
            rows={3}
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
            <button
              onClick={createReleaseAndView}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.18)",
                background: canRelease ? "rgba(255,255,255,0.14)" : "rgba(255,255,255,0.05)",
                color: canRelease ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 1000,
              }}
              title={canRelease ? "Freeze drafts + open Release Viewer" : "Create at least 1 draft first"}
            >
              Release → View Public Record
            </button>

            <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12 }}>
              Releases stored at: <span style={{ opacity: 0.9 }}>{RELEASES_KEY}</span>
            </div>
          </div>
        </div>

        {releases.length > 0 && (
          <div style={{ marginTop: 12 }}>
            <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 12, marginBottom: 8 }}>
              Recent Releases
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 10 }}>
              {releases.slice(0, 6).map((r) => (
                <div
                  key={r.id}
                  style={{
                    borderRadius: 14,
                    border: "1px solid rgba(255,255,255,0.10)",
                    background: "rgba(0,0,0,0.18)",
                    padding: 12,
                  }}
                >
                  <div style={{ fontWeight: 900 }}>{r.title}</div>
                  <div style={{ marginTop: 6, color: "rgba(255,255,255,0.65)", fontSize: 12, lineHeight: 1.35 }}>
                    Released: {fmt(r.createdAt)} • Drafts: {r.artifactIds.length}
                  </div>

                  <button
                    onClick={() => viewRelease(r.id)}
                    style={{
                      marginTop: 10,
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.14)",
                      background: "rgba(255,255,255,0.08)",
                      color: "rgba(255,255,255,0.92)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    View Release →
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
