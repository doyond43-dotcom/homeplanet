import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useOutletContext } from "react-router-dom";

type Ctx = { witnessMode?: boolean };

export default function CreatorBuild() {
  const ctx = useOutletContext() as Ctx;
  const witness = !!ctx?.witnessMode;
  const nav = useNavigate();

  // -----------------------------
  // IDEA STATE
  // -----------------------------
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [status, setStatus] = useState<string | null>("Saved");

  const composerRef = useRef<HTMLInputElement | null>(null);

  // -----------------------------
  // VOICE INPUT (Web Speech API)
  // -----------------------------
  const SpeechRecognition =
    (window as any).SpeechRecognition ||
    (window as any).webkitSpeechRecognition;

  const voiceSupported = !!SpeechRecognition;
  const [listening, setListening] = useState(false);
  const recognitionRef = useRef<any>(null);

  function startVoiceInput() {
    if (!voiceSupported || listening) return;

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.continuous = false;

    recognition.onstart = () => {
      setListening(true);
      setStatus("Listening…");
    };

    recognition.onresult = (event: any) => {
      const transcript = Array.from(event.results)
        .map((r: any) => r[0].transcript)
        .join(" ")
        .trim();

      if (transcript) {
        setBody((prev) =>
          prev ? prev + "\n\n" + transcript : transcript
        );
        setStatus("Saved");
      }
    };

    recognition.onerror = () => {
      setStatus("Voice input failed");
      setListening(false);
    };

    recognition.onend = () => {
      setListening(false);
    };

    recognition.start();
    recognitionRef.current = recognition;
  }

  // -----------------------------
  // UI
  // -----------------------------
  return (
    <div
      style={{
        maxWidth: 1100,
        margin: "0 auto",
        padding: "24px 20px 60px",
      }}
    >
      {/* CITY HEADER */}
      <div
        style={{
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.04)",
          padding: 16,
          marginBottom: 18,
          display: "flex",
          gap: 12,
          alignItems: "center",
        }}
      >
        <div style={{ fontSize: 22 }}>🌍</div>

        <div>
          <div style={{ fontWeight: 900, fontSize: 16 }}>Creator City</div>
          <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 13 }}>
            Shape an idea into something real
          </div>
        </div>

        <div
          style={{
            marginLeft: "auto",
            fontSize: 12,
            color: "rgba(255,255,255,0.55)",
          }}
        >
          Witness{" "}
          <span style={{ fontWeight: 900, color: "rgba(255,255,255,0.85)" }}>
            {witness ? "ON" : "OFF"}
          </span>
        </div>
      </div>

      {/* HERO */}
      <div style={{ marginBottom: 12 }}>
        <div style={{ fontSize: 22, fontWeight: 800 }}>
          Start with an idea.
        </div>
      </div>

      {/* IDEA CORE */}
      <div
        style={{
          borderRadius: 22,
          border: "1px solid rgba(255,255,255,0.12)",
          background: "rgba(255,255,255,0.05)",
          padding: 18,
          marginBottom: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Idea</div>

        <div
          style={{
            borderRadius: 18,
            border: "1px solid rgba(255,255,255,0.12)",
            background: "rgba(255,255,255,0.04)",
            padding: 16,
          }}
        >
          {/* TITLE + MIC */}
          <div style={{ display: "flex", gap: 10, alignItems: "center" }}>
            <input
              ref={composerRef}
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              placeholder="Example: Creator flow that actually works"
              style={{
                flex: 1,
                padding: "12px 14px",
                fontSize: 15,
                fontWeight: 800,
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.14)",
                background: "rgba(0,0,0,0.25)",
                color: "rgba(255,255,255,0.92)",
                outline: "none",
              }}
            />

            {voiceSupported && (
              <button
                onClick={startVoiceInput}
                title="Speak your idea"
                style={{
                  width: 44,
                  height: 44,
                  borderRadius: 12,
                  border: "1px solid rgba(255,255,255,0.16)",
                  background: listening
                    ? "rgba(255,255,255,0.18)"
                    : "rgba(255,255,255,0.08)",
                  fontSize: 18,
                  cursor: "pointer",
                }}
              >
                {listening ? "🎙️" : "🎤"}
              </button>
            )}
          </div>

          {/* BODY */}
          <textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder={`Example:

I want creators to land here and immediately start moving.
No setup. No confusion. No waiting.

The system should stay out of the way while I think,
then lock things in the moment I act.`}
            rows={7}
            style={{
              width: "100%",
              marginTop: 12,
              padding: "14px",
              fontSize: 14,
              lineHeight: 1.55,
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(0,0,0,0.28)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />
        </div>
      </div>

      {/* GRAVITY STRIP */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          fontSize: 13,
          color: "rgba(255,255,255,0.55)",
        }}
      >
        <div>● {status}</div>

        <div style={{ display: "flex", gap: 16 }}>
          <span
            style={{ cursor: "pointer", fontWeight: 800 }}
            onClick={() => nav("/planet/creator/projects")}
          >
            All Ideas
          </span>
          <span
            style={{ cursor: "pointer", fontWeight: 800 }}
            onClick={() => nav("/planet/creator/projects")}
          >
            Switch Project
          </span>
        </div>
      </div>
    </div>
  );
}

