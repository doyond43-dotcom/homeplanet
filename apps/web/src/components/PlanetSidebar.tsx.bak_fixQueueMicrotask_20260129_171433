import React, { useMemo, useRef, useState, useCallback } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { PLANETS } from "../planet/planetMap";

type City = { id: string; label: string; desc?: string };

function normalizeCities(input: any): City[] {
  if (!input) return [];
  return (Array.isArray(input) ? input : [])
    .map((c) => ({
      id: String(c?.id ?? ""),
      label: String(c?.label ?? c?.name ?? c?.title ?? c?.id ?? "City"),
      desc: c?.desc ? String(c.desc) : c?.subtitle ? String(c.subtitle) : undefined,
    }))
    .filter((c) => c.id);
}

/**
 * PlanetSidebar — iOS-safe navigation (single-event)
 * Fixes:
 * - Avoids double/triple event firing (onClick ONLY)
 * - Correct toggle using state value (no stale isOpen capture)
 * - Uses BUTTONs for internal navigation
 * - Adds hard fallback if router navigation fails
 */
export function PlanetSidebar(props: { witnessMode: boolean; onToggleWitnessMode: () => void }) {
  const { witnessMode, onToggleWitnessMode } = props;
  void witnessMode;
  void onToggleWitnessMode;

  const navigate = useNavigate();
  const location = useLocation();

  // which planet sections are expanded
  const [open, setOpen] = useState<Record<string, boolean>>(() => {
    const initial: Record<string, boolean> = {};
    for (const p of PLANETS as any[]) initial[String(p.id)] = false;
    return initial;
  });

  const lastNavRef = useRef<number>(0);

  const isActive = (to: string) => location.pathname === to;

  const activeGlow = (on: boolean): React.CSSProperties =>
    on
      ? {
          border: "1px solid rgba(0,255,180,0.28)",
          background: "rgba(0,255,180,0.08)",
        }
      : {};

  const go = useCallback(
    (to: string, e?: any) => {
      try {
        e?.preventDefault?.();
        e?.stopPropagation?.();
      } catch {}

      const now = Date.now();
      if (now - lastNavRef.current < 350) return; // prevent double-fire
      lastNavRef.current = now;

      // already there? no-op
      if (location.pathname === to) return;

      // Attempt react-router navigation
      try {
        navigate(to);
      } catch {}

      // Hard fallback: if router didn’t update path, force location change
      queueMicrotask(() => {
        if (window.location.pathname !== to) {
          window.location.assign(to);
        }
      });
    },
    [navigate, location.pathname]
  );

  const planets = useMemo(() => (PLANETS as any[]) ?? [], []);

  const shell: React.CSSProperties = {
    position: "sticky",
    top: 0,
    height: "100dvh",
    overflowY: "auto",
    padding: 14,
    paddingBottom: "calc(14px + env(safe-area-inset-bottom))",
    borderRight: "1px solid rgba(255,255,255,0.10)",
    background: "rgba(0,0,0,0.55)",
    backdropFilter: "blur(10px)",
    WebkitBackdropFilter: "blur(10px)",

    pointerEvents: "auto",
    touchAction: "manipulation",
    WebkitTapHighlightColor: "transparent",
  };

  const title: React.CSSProperties = { margin: 0, fontSize: 16, fontWeight: 950 };
  const subtitle: React.CSSProperties = { marginTop: 4, fontSize: 12, color: "rgba(255,255,255,0.62)" };

  const sectionLabel: React.CSSProperties = {
    fontSize: 12,
    fontWeight: 800,
    color: "rgba(255,255,255,0.70)",
    paddingLeft: 6,
    marginTop: 14,
  };

  const row: React.CSSProperties = {
    width: "100%",
    display: "flex",
    alignItems: "center",
    justifyContent: "space-between",
    gap: 10,
    padding: "10px 12px",
    borderRadius: 14,
    border: "1px solid rgba(255,255,255,0.10)",
    background: "rgba(255,255,255,0.04)",
    color: "rgba(255,255,255,0.92)",
    cursor: "pointer",
    userSelect: "none",
    textDecoration: "none",
    touchAction: "manipulation",
    WebkitTapHighlightColor: "transparent",
  };

  const subRow: React.CSSProperties = {
    ...row,
    marginLeft: 10,
    background: "rgba(0,0,0,0.20)",
    border: "1px solid rgba(255,255,255,0.08)",
  };

  const caret: React.CSSProperties = { opacity: 0.65, fontWeight: 900 };

  // Shared nav props — single event to avoid duplicate toggles on iOS
  const tapSafeNavProps = (to: string) => ({
    onClick: (e: any) => go(to, e),
  });

  return (
    <aside style={shell}>
      <div style={{ marginBottom: 8 }}>
        <div style={title}>HomePlanet</div>
        <div style={subtitle}>Presence-first navigation</div>
      </div>

      <div style={sectionLabel}>Planets</div>

      <div style={{ display: "grid", gap: 10, marginTop: 10 }}>
        {planets.map((p) => {
          const planetId = String(p.id);
          const planetLabel = String(p.label ?? p.id);
          const cities = normalizeCities(p.cities);

          const isOpen = !!open[planetId];

          // Top-level planet "row" is a toggle, not a link
          return (
            <div key={planetId} style={{ display: "grid", gap: 8 }}>
              <button
                type="button"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  setOpen((s) => ({ ...s, [planetId]: !s[planetId] })); // ✅ state-safe toggle
                }}
                style={{
                  ...row,
                  width: "100%",
                  border: "1px solid rgba(255,255,255,0.12)",
                  background: "rgba(255,255,255,0.05)",
                }}
              >
                <div style={{ display: "flex", flexDirection: "column", alignItems: "flex-start" }}>
                  <div style={{ fontWeight: 950 }}>{planetLabel}</div>
                  {p.subtitle ? (
                    <div style={{ fontSize: 12, color: "rgba(255,255,255,0.55)", marginTop: 2 }}>
                      {String(p.subtitle)}
                    </div>
                  ) : null}
                </div>
                <div style={caret}>{isOpen ? "▾" : "▸"}</div>
              </button>

              {isOpen ? (
                <div style={{ display: "grid", gap: 8 }}>
                  {/* Planet overview */}
                  {(() => {
                    const to = `/planet/${planetId}`;
                    return (
                      <button type="button" {...tapSafeNavProps(to)} style={{ ...subRow, ...activeGlow(isActive(to)) }}>
                        <div style={{ fontWeight: 900 }}>Overview</div>
                        <div style={caret}>→</div>
                      </button>
                    );
                  })()}

                  {/* Cities */}
                  {cities.slice(0, 12).map((c) => {
                    const to = `/planet/${planetId}/${c.id}`;
                    return (
                      <button
                        key={c.id}
                        type="button"
                        {...tapSafeNavProps(to)}
                        style={{ ...subRow, ...activeGlow(isActive(to)) }}
                      >
                        <div style={{ display: "flex", flexDirection: "column" }}>
                          <div style={{ fontWeight: 900 }}>{c.label}</div>
                          {c.desc ? <div style={{ fontSize: 12, opacity: 0.6, marginTop: 2 }}>{c.desc}</div> : null}
                        </div>
                        <div style={caret}>→</div>
                      </button>
                    );
                  })}
                </div>
              ) : null}
            </div>
          );
        })}
      </div>

      <div style={{ marginTop: 18, opacity: 0.5, fontSize: 11, lineHeight: 1.35, paddingLeft: 6 }}>
        If a tap highlights but doesn’t navigate on iOS, this sidebar uses click + navigate() + a hard fallback.
      </div>
    </aside>
  );
}


