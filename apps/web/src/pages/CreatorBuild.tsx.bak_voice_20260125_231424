import { useEffect, useMemo, useRef, useState } from "react";
import { useNavigate, useOutletContext } from "react-router-dom";

type Ctx = { witnessMode?: boolean };

type Project = {
  id: string;
  name: string;
  description?: string;
  createdAt: number;
};

type Artifact = {
  id: string;
  title: string;
  body: string;
  createdAt: number; // presence-first creation moment for this artifact
  updatedAt: number;
};

type Release = {
  id: string;
  projectId: string;
  title: string;
  statement: string;
  artifactIds: string[];
  createdAt: number;
};

const PROJECTS_KEY = "hp.creator.projects.v1";
const ACTIVE_PROJECT_KEY = "hp.creator.activeProjectId.v1";
const ACTIVE_ARTIFACT_KEY = "hp.creator.activeArtifactId.v1";
const RELEASES_KEY = "hp.creator.build.releases.v1";

function safeJsonParse<T>(raw: string | null, fallback: T): T {
  try {
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function now() {
  return Date.now();
}

function makeId(prefix: string) {
  const t = now();
  const rnd =
    globalThis.crypto && "randomUUID" in globalThis.crypto
      ? globalThis.crypto.randomUUID()
      : Math.random().toString(16).slice(2);
  return `${prefix}_${t}_${rnd}`;
}

function fmt(ms: number) {
  return new Date(ms).toLocaleString();
}

export default function CreatorBuild() {
  const ctx = useOutletContext() as Ctx;
  const witness = !!ctx?.witnessMode;
  const nav = useNavigate();

  const [project, setProject] = useState<Project | null>(null);
  const [artifacts, setArtifacts] = useState<Artifact[]>([]);
  const [activeArtifactId, setActiveArtifactId] = useState<string | null>(null);

  // ✅ This is the "Idea surface" (it already exists in your logic)
  const [title, setTitle] = useState("");
  const [body, setBody] = useState("");
  const [status, setStatus] = useState<string | null>(null);

  // Release composer
  const [releaseTitle, setReleaseTitle] = useState("Public Release v1");
  const [releaseStatement, setReleaseStatement] = useState(
    "HomePlanet lets you build privately, then release publicly with proof that can’t be argued later."
  );
  const [releases, setReleases] = useState<Release[]>([]);

  const composerRef = useRef<HTMLInputElement | null>(null);

  const artifactsKey = useMemo(() => {
    if (!project?.id) return null;
    return `hp.creator.build.artifacts.v1.${project.id}`;
  }, [project?.id]);

  // Load active project + artifacts + releases
  useEffect(() => {
    const projects = safeJsonParse<Project[]>(
      localStorage.getItem(PROJECTS_KEY),
      []
    );
    const activeId = localStorage.getItem(ACTIVE_PROJECT_KEY);

    const p = projects.find((x) => x.id === activeId) ?? null;
    setProject(p);

    const allReleases = safeJsonParse<Release[]>(
      localStorage.getItem(RELEASES_KEY),
      []
    );
    setReleases(allReleases.sort((a, b) => b.createdAt - a.createdAt));

    if (p) {
      const key = `hp.creator.build.artifacts.v1.${p.id}`;
      const items = safeJsonParse<Artifact[]>(localStorage.getItem(key), []);
      items.sort((a, b) => b.createdAt - a.createdAt);
      setArtifacts(items);

      const aa = localStorage.getItem(ACTIVE_ARTIFACT_KEY);
      setActiveArtifactId(
        aa && items.some((x) => x.id === aa) ? aa : items[0]?.id ?? null
      );
    } else {
      setArtifacts([]);
      setActiveArtifactId(null);
    }
  }, []);

  // Persist artifacts
  useEffect(() => {
    if (!artifactsKey) return;
    try {
      localStorage.setItem(artifactsKey, JSON.stringify(artifacts));
    } catch {
      // ignore
    }
  }, [artifactsKey, artifacts]);

  // Persist active artifact
  useEffect(() => {
    try {
      if (activeArtifactId) {
        localStorage.setItem(ACTIVE_ARTIFACT_KEY, activeArtifactId);
      }
    } catch {
      // ignore
    }
  }, [activeArtifactId]);

  // Persist releases
  useEffect(() => {
    try {
      localStorage.setItem(RELEASES_KEY, JSON.stringify(releases));
    } catch {
      // ignore
    }
  }, [releases]);

  const activeArtifact = useMemo(
    () => artifacts.find((a) => a.id === activeArtifactId) ?? null,
    [artifacts, activeArtifactId]
  );

  const canCreate = title.trim().length >= 2;
  const canRelease = !!project && artifacts.length > 0 && releaseTitle.trim().length >= 2;

  function goSwitchProject() {
    nav("/planet/creator/projects");
  }

  function startBuilding() {
    setStatus("Pick a title and create your first draft.");
    window.setTimeout(() => composerRef.current?.focus(), 60);
  }

  function createArtifact() {
    setStatus(null);

    const t = title.trim();
    if (t.length < 2) {
      setStatus("Title must be at least 2 characters.");
      composerRef.current?.focus();
      return;
    }

    const id = makeId("a");
    const ts = now();

    const a: Artifact = {
      id,
      title: t,
      body: body ?? "",
      createdAt: ts,
      updatedAt: ts,
    };

    setArtifacts((prev) => [a, ...prev]);
    setActiveArtifactId(id);

    setTitle("");
    setBody("");

    setStatus("Saved. Draft created.");
  }

  function openArtifact(id: string) {
    setActiveArtifactId(id);
    setStatus(null);
  }

  function updateActiveBody(next: string) {
    if (!activeArtifactId) return;
    setArtifacts((prev) =>
      prev.map((a) =>
        a.id === activeArtifactId ? { ...a, body: next, updatedAt: now() } : a
      )
    );
    // Optional: keep status calm + factual
    setStatus("Saved.");
  }

  function removeArtifact(id: string) {
    setArtifacts((prev) => prev.filter((a) => a.id !== id));
    if (activeArtifactId === id) {
      const next = artifacts.find((a) => a.id !== id)?.id ?? null;
      setActiveArtifactId(next);
    }
    setStatus("Saved.");
  }

  function createReleaseAndView() {
    setStatus(null);
    if (!project) return;

    if (!canRelease) {
      setStatus("To release, you need at least 1 draft and a release title.");
      return;
    }

    const r: Release = {
      id: makeId("r"),
      projectId: project.id,
      title: releaseTitle.trim(),
      statement: releaseStatement.trim() || "Released publicly with anchored proof.",
      artifactIds: artifacts.map((a) => a.id),
      createdAt: now(),
    };

    setReleases((prev) => [r, ...prev]);
    setStatus("Released. Opening the public viewer…");

    nav(`/planet/creator/release/${r.id}`);
  }

  function viewRelease(rid: string) {
    nav(`/planet/creator/release/${rid}`);
  }

  // Missing project: keep your existing behavior (no white screen)
  if (!project) {
    return (
      <div
        style={{
          maxWidth: 1100,
          margin: "0 auto",
          padding: "24px 20px 60px",
        }}
      >
        <div
          style={{
            borderRadius: 18,
            border: "1px solid rgba(255,255,255,0.10)",
            background: "rgba(255,255,255,0.04)",
            padding: 16,
            marginBottom: 18,
            display: "flex",
            gap: 12,
            alignItems: "center",
          }}
        >
          <div style={{ fontSize: 22 }}>🌍</div>
          <div>
            <div style={{ fontWeight: 900, fontSize: 16 }}>Creator City</div>
            <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 13 }}>
              Shape an idea into something real
            </div>
          </div>
        </div>

        <div style={{ fontSize: 22, fontWeight: 800, marginBottom: 8 }}>
          Start with an idea.
        </div>

        <p style={{ marginTop: 10, color: "rgba(255,255,255,0.70)", lineHeight: 1.5 }}>
          Build starts from an anchored project — but none is selected.
        </p>

        <button
          onClick={goSwitchProject}
          style={{
            marginTop: 12,
            padding: "10px 12px",
            borderRadius: 12,
            border: "1px solid rgba(255,255,255,0.14)",
            background: "rgba(255,255,255,0.08)",
            color: "rgba(255,255,255,0.92)",
            cursor: "pointer",
            fontWeight: 900,
          }}
        >
          Go select a project →
        </button>
      </div>
    );
  }

  return (
    <div
      style={{
        maxWidth: 1100,
        margin: "0 auto",
        padding: "24px 20px 60px",
      }}
    >
      {/* CITY HEADER BLOCK (HomePlanet-style) */}
      <div
        style={{
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.04)",
          padding: 16,
          marginBottom: 18,
          display: "flex",
          gap: 12,
          alignItems: "center",
        }}
      >
        <div style={{ fontSize: 22 }}>🌍</div>

        <div>
          <div style={{ fontWeight: 900, fontSize: 16 }}>Creator City</div>
          <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 13 }}>
            Shape an idea into something real
          </div>
        </div>

        <div style={{ marginLeft: "auto", fontSize: 12, color: "rgba(255,255,255,0.55)" }}>
          Witness:{" "}
          <span style={{ color: "rgba(255,255,255,0.85)", fontWeight: 900 }}>
            {witness ? "ON" : "OFF"}
          </span>
        </div>
      </div>

      {/* HERO (locked) */}
      <div style={{ marginBottom: 12 }}>
        <div style={{ fontSize: 22, fontWeight: 800, letterSpacing: "0.2px", marginBottom: 6 }}>
          Start with an idea.
        </div>
      </div>

      {/* IDEA CORE BLOCK (primary first 30 seconds) */}
      <div
        style={{
          borderRadius: 22,
          border: "1px solid rgba(255,255,255,0.12)",
          background: "rgba(255,255,255,0.05)",
          padding: 18,
          marginBottom: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10, color: "rgba(255,255,255,0.85)" }}>
          Idea
        </div>

        <div
          style={{
            borderRadius: 18,
            border: "1px solid rgba(255,255,255,0.12)",
            background: "rgba(255,255,255,0.04)",
            padding: 16,
          }}
        >
          <input
            ref={composerRef}
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            placeholder="Example: Creator flow that actually works"
            style={{
              width: "100%",
              padding: "12px 14px",
              fontSize: 15,
              fontWeight: 800,
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              marginBottom: 12,
            }}
          />

          <textarea
            value={body}
            onChange={(e) => setBody(e.target.value)}
            placeholder={`Example:

I want creators to land here and immediately start moving.
No setup. No confusion. No waiting.

The system should stay out of the way while I think,
then lock things in the moment I act.

This idea is about momentum — not perfection.`}
            rows={7}
            style={{
              width: "100%",
              padding: "14px",
              fontSize: 14,
              lineHeight: 1.55,
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(0,0,0,0.28)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center", marginTop: 12 }}>
            <button
              onClick={createArtifact}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.16)",
                background: canCreate ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.05)",
                color: canCreate ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 900,
              }}
              title={canCreate ? "Create draft" : "Enter a title first"}
            >
              Save Draft →
            </button>

            {status && <div style={{ color: "rgba(255,255,255,0.70)", fontSize: 12 }}>{status}</div>}
          </div>
        </div>
      </div>

      {/* GRAVITY STRIP (quiet navigation + safety) */}
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: 24,
          color: "rgba(255,255,255,0.55)",
          fontSize: 13,
        }}
      >
        <div>● {status ? status.replace(/\.$/, "") : "Saved"}</div>

        <div style={{ display: "flex", gap: 16 }}>
          <span
            style={{ cursor: "pointer", color: "rgba(255,255,255,0.75)", fontWeight: 800 }}
            onClick={() => nav("/planet/creator/projects")}
            title="Go back to all ideas"
          >
            All Ideas
          </span>

          <span
            style={{ cursor: "pointer", color: "rgba(255,255,255,0.75)", fontWeight: 800 }}
            onClick={goSwitchProject}
            title="Switch to a different project"
          >
            Switch Project
          </span>
        </div>
      </div>

      {/* BELOW: existing Build UI, quieter / secondary */}

      {/* ACTIVE PROJECT (quiet) */}
      <div
        style={{
          marginTop: 6,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 8 }}>Active Project</div>

        <div style={{ fontWeight: 900, fontSize: 16 }}>{project.name}</div>
        {project.description && (
          <div style={{ marginTop: 8, color: "rgba(255,255,255,0.70)", lineHeight: 1.45 }}>
            {project.description}
          </div>
        )}

        <div style={{ marginTop: 10, color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
          Presence Anchor: {fmt(project.createdAt)}{" "}
          {witness ? <span style={{ marginLeft: 10, opacity: 0.9 }}>• Witness ON</span> : null}
        </div>

        <div style={{ marginTop: 12, display: "flex", gap: 10, flexWrap: "wrap" }}>
          <button
            onClick={startBuilding}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.16)",
              background: "rgba(255,255,255,0.08)",
              color: "rgba(255,255,255,0.92)",
              cursor: "pointer",
              fontWeight: 900,
            }}
          >
            Focus →
          </button>

          <button
            onClick={goSwitchProject}
            style={{
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.20)",
              color: "rgba(255,255,255,0.78)",
              cursor: "pointer",
              fontWeight: 900,
            }}
          >
            Switch Project
          </button>

          <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12, alignSelf: "center" }}>
            Active ID stored at: {ACTIVE_PROJECT_KEY}
          </div>
        </div>
      </div>

      {/* DRAFTS + EDITOR (quiet) */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "baseline", gap: 12 }}>
          <div style={{ fontWeight: 900 }}>Drafts</div>
          <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>Count: {artifacts.length}</div>
        </div>

        <div style={{ marginTop: 12, display: "grid", gridTemplateColumns: "minmax(260px, 360px) 1fr", gap: 12 }}>
          {/* List */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 10,
              minHeight: 160,
            }}
          >
            {artifacts.length === 0 ? (
              <div style={{ color: "rgba(255,255,255,0.65)", padding: 10 }}>
                No drafts yet. Create one above.
              </div>
            ) : (
              artifacts.map((a) => {
                const active = a.id === activeArtifactId;
                return (
                  <button
                    key={a.id}
                    onClick={() => openArtifact(a.id)}
                    style={{
                      width: "100%",
                      textAlign: "left",
                      padding: "10px 10px",
                      borderRadius: 12,
                      border: active
                        ? "1px solid rgba(255,255,255,0.22)"
                        : "1px solid rgba(255,255,255,0.10)",
                      background: active ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.03)",
                      color: "rgba(255,255,255,0.90)",
                      cursor: "pointer",
                      fontWeight: 900,
                      marginBottom: 8,
                    }}
                    title="Open draft"
                  >
                    <div style={{ fontSize: 13 }}>{a.title}</div>
                    <div style={{ marginTop: 4, fontSize: 11, color: "rgba(255,255,255,0.55)", fontWeight: 700 }}>
                      Created: {fmt(a.createdAt)}
                    </div>
                  </button>
                );
              })
            )}
          </div>

          {/* Editor */}
          <div
            style={{
              borderRadius: 16,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(0,0,0,0.18)",
              padding: 12,
              minHeight: 160,
            }}
          >
            {!activeArtifact ? (
              <div style={{ color: "rgba(255,255,255,0.65)" }}>Select a draft to open it here.</div>
            ) : (
              <>
                <div style={{ display: "flex", justifyContent: "space-between", gap: 12, alignItems: "baseline" }}>
                  <div style={{ fontWeight: 900 }}>{activeArtifact.title}</div>
                  <div style={{ color: "rgba(255,255,255,0.55)", fontSize: 12 }}>
                    Updated: {fmt(activeArtifact.updatedAt)}
                  </div>
                </div>

                <textarea
                  value={activeArtifact.body}
                  onChange={(e) => updateActiveBody(e.target.value)}
                  placeholder="Write here…"
                  rows={10}
                  style={{
                    marginTop: 10,
                    width: "100%",
                    padding: "10px 12px",
                    borderRadius: 12,
                    border: "1px solid rgba(255,255,255,0.12)",
                    background: "rgba(0,0,0,0.22)",
                    color: "rgba(255,255,255,0.92)",
                    outline: "none",
                    resize: "vertical",
                  }}
                />

                <div style={{ marginTop: 10, display: "flex", justifyContent: "flex-end" }}>
                  <button
                    onClick={() => removeArtifact(activeArtifact.id)}
                    style={{
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.12)",
                      background: "rgba(0,0,0,0.20)",
                      color: "rgba(255,255,255,0.75)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    Remove Draft
                  </button>
                </div>

                <div style={{ marginTop: 8, color: "rgba(255,255,255,0.45)", fontSize: 11 }}>
                  Presence Anchor: {fmt(activeArtifact.createdAt)} • ID: {activeArtifact.id}
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      {/* RELEASE (quiet) */}
      <div
        style={{
          marginTop: 16,
          borderRadius: 18,
          border: "1px solid rgba(255,255,255,0.10)",
          background: "rgba(255,255,255,0.03)",
          padding: 14,
        }}
      >
        <div style={{ fontWeight: 900, marginBottom: 10 }}>Release (Public Truth)</div>

        <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: 10 }}>
          <input
            value={releaseTitle}
            onChange={(e) => setReleaseTitle(e.target.value)}
            placeholder="Release title (example: Creator Demo Release v1)"
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
            }}
          />

          <textarea
            value={releaseStatement}
            onChange={(e) => setReleaseStatement(e.target.value)}
            placeholder="Release statement (the one-sentence lock-in)"
            rows={3}
            style={{
              width: "100%",
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.12)",
              background: "rgba(0,0,0,0.25)",
              color: "rgba(255,255,255,0.92)",
              outline: "none",
              resize: "vertical",
            }}
          />

          <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
            <button
              onClick={createReleaseAndView}
              style={{
                padding: "10px 12px",
                borderRadius: 12,
                border: "1px solid rgba(255,255,255,0.18)",
                background: canRelease ? "rgba(255,255,255,0.14)" : "rgba(255,255,255,0.05)",
                color: canRelease ? "rgba(255,255,255,0.92)" : "rgba(255,255,255,0.55)",
                cursor: "pointer",
                fontWeight: 1000,
              }}
              title={canRelease ? "Freeze drafts + open Release Viewer" : "Create at least 1 draft first"}
            >
              Release → View Public Record
            </button>

            <div style={{ marginLeft: "auto", color: "rgba(255,255,255,0.45)", fontSize: 12 }}>
              Releases stored at: <span style={{ opacity: 0.9 }}>{RELEASES_KEY}</span>
            </div>
          </div>
        </div>

        {releases.length > 0 && (
          <div style={{ marginTop: 12 }}>
            <div style={{ color: "rgba(255,255,255,0.65)", fontSize: 12, marginBottom: 8 }}>
              Recent Releases
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 10 }}>
              {releases.slice(0, 6).map((r) => (
                <div
                  key={r.id}
                  style={{
                    borderRadius: 14,
                    border: "1px solid rgba(255,255,255,0.10)",
                    background: "rgba(0,0,0,0.18)",
                    padding: 12,
                  }}
                >
                  <div style={{ fontWeight: 900 }}>{r.title}</div>
                  <div style={{ marginTop: 6, color: "rgba(255,255,255,0.65)", fontSize: 12, lineHeight: 1.35 }}>
                    Released: {fmt(r.createdAt)} • Drafts: {r.artifactIds.length}
                  </div>

                  <button
                    onClick={() => viewRelease(r.id)}
                    style={{
                      marginTop: 10,
                      padding: "8px 10px",
                      borderRadius: 12,
                      border: "1px solid rgba(255,255,255,0.14)",
                      background: "rgba(255,255,255,0.08)",
                      color: "rgba(255,255,255,0.92)",
                      cursor: "pointer",
                      fontWeight: 900,
                    }}
                  >
                    View Release →
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

