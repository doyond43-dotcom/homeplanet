import { useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import { LiveKitRoom, GridLayout, ParticipantTile, ControlBar, useTracks } from "@livekit/components-react";
import "@livekit/components-styles";
import { useAuth } from "../auth/AuthProvider";

function slugRoom() {
  return "live-" + Math.random().toString(16).slice(2, 8);
}

export default function CreatorLive() {
  const { user } = useAuth();
  const nav = useNavigate();

  const [room] = useState(() => slugRoom());
  const [token, setToken] = useState<string | null>(null);
  const [url, setUrl] = useState<string | null>(null);
  const [busy, setBusy] = useState(false);

  const publicLink = useMemo(() => `${location.origin}/live/${room}`, [room]);

  async function start() {
    if (!user) return;
    setBusy(true);
    try {
      const qs = new URLSearchParams({
        room,
        identity: user.id,
        name: user.email ?? "Host",
        role: "host",
      });

      const r = await fetch(`/api/livekit-token?${qs.toString()}`);
      const j = await r.json();
      if (!r.ok) throw new Error(j?.error ?? "token failed");
      setToken(j.token);
      setUrl(j.url);
    } catch (e: any) {
      alert(e?.message ?? "Failed to start live");
    } finally {
      setBusy(false);
    }
  }

  return (
    <div>
      <h2 style={{ marginTop: 0 }}>Creator Live</h2>

      <div style={{ display: "grid", gap: 10, maxWidth: 820 }}>
        <div style={{ fontSize: 13, opacity: 0.8 }}>
          Share this link for public viewers:
        </div>

        <div style={{
          padding: "10px 12px",
          borderRadius: 12,
          border: "1px solid rgba(255,255,255,0.12)",
          background: "rgba(0,0,0,0.25)",
          display: "flex",
          gap: 10,
          alignItems: "center",
          justifyContent: "space-between"
        }}>
          <code style={{ fontSize: 12, opacity: 0.95 }}>{publicLink}</code>
          <button
            onClick={() => navigator.clipboard.writeText(publicLink)}
            style={{
              padding: "8px 10px",
              borderRadius: 10,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(255,255,255,0.06)",
              color: "rgba(255,255,255,0.92)",
              cursor: "pointer"
            }}
          >
            Copy link
          </button>
        </div>

        {!token ? (
          <button
            onClick={start}
            disabled={busy}
            style={{
              width: 220,
              padding: "10px 12px",
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(255,255,255,0.08)",
              color: "rgba(255,255,255,0.92)",
              cursor: busy ? "not-allowed" : "pointer",
              opacity: busy ? 0.6 : 1
            }}
          >
            {busy ? "Starting…" : "Go Live"}
          </button>
        ) : null}

        {token && url ? (
          <LiveKitRoom
            token={token}
            serverUrl={url}
            connect={true}
            video={true}
            audio={true}
            data-lk-theme="default"
            style={{ height: "60vh" }}
          >
            <GridLayout tracks={tracks} style={{ height: "100%" }}>
              <ParticipantTile />
            </GridLayout>
            <ControlBar />
          </LiveKitRoom>
        ) : null}

        <div style={{ display: "flex", gap: 10, marginTop: 8 }}>
          <button
            onClick={() => nav(`/live/${room}`)}
            style={{
              padding: "8px 10px",
              borderRadius: 10,
              border: "1px solid rgba(255,255,255,0.14)",
              background: "rgba(255,255,255,0.06)",
              color: "rgba(255,255,255,0.92)",
              cursor: "pointer"
            }}
          >
            Open viewer link (test)
          </button>
        </div>
      </div>
    </div>
  );
}

